# ADR 003: 開發階段的資料庫遷移重置策略

- **狀態**: 已接受 (Accepted)
- **日期**: 2025-06-29

---

## 1. 背景 (Context)

在實施 ADR 002 的新資料模型時，我們面臨了一個重要的決策：如何處理現有的資料庫遷移檔案。

原有的遷移檔案基於舊的 `Calendar -> Event` 模型，而新的架構採用 `Calendar -> List -> ListItem` 加上 `Vote` 和重新設計的 `Event` 模型。兩種架構差異極大，無法透過簡單的遷移腳本進行轉換。

我們有兩個選擇：
1. **漸進式遷移**：保留所有現有遷移，新增複雜的遷移腳本來重構資料結構
2. **遷移重置**：刪除現有遷移檔案，從新模型開始建立初始遷移

## 2. 決策 (Decision)

我們決定在**開發階段**採用**遷移重置策略**，理由如下：

### 2.1 支持重置的因素

- **專案初期**：DateTree 仍在開發階段，沒有生產資料需要保護
- **架構差異巨大**：新舊模型差異過大，漸進式遷移會產生大量複雜且難以維護的遷移檔案
- **團隊規模小**：開發團隊規模小，協調重置工作相對簡單
- **清晰的初始狀態**：重置後的初始遷移更清晰地反映了最終的資料結構
- **減少技術債務**：避免累積過多的遷移檔案和歷史包袱

### 2.2 重置執行步驟

1. **備份重要資料**（如果有的話）
2. **刪除現有遷移檔案**：`rm -rf alembic/versions/*.py`
3. **清理資料庫**：重建開發資料庫
4. **產生新的初始遷移**：`alembic revision --autogenerate -m "Initial migration"`
5. **套用新遷移**：`alembic upgrade head`
6. **更新文檔**：記錄遷移重置的原因和過程

## 3. 限制和約束 (Constraints)

### 3.1 僅適用於開發階段

**重要**：此策略僅適用於開發階段。一旦進入生產環境，必須改用漸進式遷移策略。

### 3.2 團隊協調

所有開發團隊成員都需要：
- 了解遷移重置的決策和原因
- 在重置後重建其本地開發環境
- 更新其開發流程以配合新的資料模型

### 3.3 文檔更新

需要更新以下文檔來反映新的模型和遷移策略：
- 後端 README.md
- 後端 CONTRIBUTING.md  
- 根目錄文檔
- ADR 文檔

## 4. 後果 (Consequences)

### 4.1 正面影響

- **清晰的遷移歷史**：初始遷移完整反映了最終的資料結構
- **減少複雜性**：避免了複雜的資料轉換邏輯
- **提高可維護性**：新的模組化模型設計更易於維護
- **一致的開發環境**：所有開發者都從相同的資料結構開始

### 4.2 負面影響

- **開發中斷**：需要所有開發者重建本地環境
- **資料遺失風險**：任何現有的開發資料都會遺失（在此階段風險可接受）
- **文檔工作**：需要大量更新現有文檔

### 4.3 風險緩解

- **清楚的溝通**：透過文檔和團隊溝通確保所有人了解變更
- **詳細的步驟指南**：提供清晰的環境重建步驟
- **版本控制**：所有變更都透過 Git 進行版本控制

## 5. 未來考慮 (Future Considerations)

### 5.1 生產環境策略

一旦部署到生產環境，後續的所有架構變更都必須使用漸進式遷移：
- 保留所有遷移歷史
- 使用資料遷移腳本處理複雜的資料轉換
- 實施資料備份和恢復程序
- 測試每個遷移步驟

### 5.2 工具和流程

考慮建立以下工具和流程：
- 自動化的資料庫重置腳本（僅開發環境）
- 資料備份和恢復工具
- 遷移測試框架
- 生產環境部署檢查清單

### 5.3 監控和警告

建立監控機制來防止在生產環境中意外執行破壞性操作：
- 環境檢查機制
- 遷移前的確認步驟
- 自動備份程序

## 6. 參考資料 (References)

- [ADR 002: 採用可擴展的多清單協作模型](002-adopt-extendable-multi-list-model.md)
- [Alembic 官方文檔](https://alembic.sqlalchemy.org/)
- [FastAPI 資料庫指南](https://fastapi.tiangolo.com/tutorial/databases/)
