# ADR 002: 採用可擴展的多清單協作模型

- **狀態**: 完全實施 (Fully Implemented)
- **日期**: 2025-06-29
- **實施日期**: 2025-06-29
- **API 實施完成日期**: 2025-07-01

---

### 1. 背景 (Context)

在專案初期，我們設計了一個簡單的 `Calendar -> Event` (日曆 -> 事項) 的一對多模型。這個模型足以應付基本的行程安排。

然而，在進一步的討論中，我們發現了更複雜、更具協作性的需求：

- **多樣化的任務管理**：使用者不僅需要安排有確定時間的「事項」，還需要管理沒有確定時間的「待辦清單 (To-Do List)」。
- **民主式的決策過程**：團隊使用者希望能有一個「優先級清單 (Priority List)」，透過成員投票來決定任務或活動的優先順序（例如：下一個要開發的功能、週末要去的旅遊景點）。
- **從決策到執行**：需要一個明確的流程，將「優先級清單」中勝出的項目，轉換為日曆上一個有具體排程的「事項」。
- **未來擴充性**：專案需要具備長期發展的潛力，未來可能會加入更多不同類型的清單，如「習慣追蹤器」、「簡易看板」等。

目前的 `Event` 模型無法靈活地滿足以上需求，強行修改會導致模型變得臃腫且難以維護。因此，我們需要一個更具擴展性的新架構。

### 2. 決策 (Decision)

我們決定放棄原有的 `Calendar -> Event` 簡單模型，轉而採用一個更具層次感和擴展性的**巢狀多清單模型**。其核心結構如下：

1. **資料模型更新**：
    - 採用 `Calendar -> List -> ListItem` (日曆 -> 清單 -> 清單項目) 的三層結構。
    - 在 `List` (清單) 模型中，增加一個關鍵的 `type` 欄位。此欄位將用來區分清單的行為邏輯，例如 `'TODO'` 或 `'PRIORITY'`。
    - `ListItem` (清單項目) 模型將包含項目的具體內容、狀態（如 `is_completed`）及關聯的投票數。
    - 新增一個 `Vote` (投票) 模型，用來記錄哪個 `User` (使用者) 投票給了哪個 `ListItem`。
    - 原有的 `Event` 模型依然保留，但它的角色轉變為「已排程的確定事項」，作為 `ListItem` 轉換後的最終形態。

2. **核心工作流程**：
    - 使用者可以在一個 `Calendar` 下建立多個不同 `type` 的 `List`。
    - 應用程式將根據 `List` 的 `type`，在前端呈現不同的介面與操作邏輯（例如，打勾框或投票按鈕）。
    - 針對 `PRIORITY` 類型的清單，提供一個「排入行程」的功能，允許使用者將高票的 `ListItem` 轉換為日曆上的一個 `Event`。

### 3. 實際實施 (Implementation)

**已完成的模型結構**：

```
User ←→ Calendar (多對多，透過 calendar_user_association 表)
Calendar → List (一對多)
List → ListItem (一對多)
ListItem ← Vote (多對一)
User → Vote (一對多)
Calendar → Event (一對多)
User → Event (一對多，作為建立者)
```

**模型檔案結構**：
- `backend/app/models/base.py` - 基礎模型類別
- `backend/app/models/user.py` - 使用者模型
- `backend/app/models/calendar.py` - 日曆模型和使用者關聯表
- `backend/app/models/list.py` - 清單模型和 ListType 枚舉
- `backend/app/models/list_item.py` - 清單項目模型
- `backend/app/models/vote.py` - 投票模型
- `backend/app/models/event.py` - 事件模型
- `backend/app/models/__init__.py` - 所有模型的匯入

**資料庫遷移**：
- 刪除了舊的遷移檔案
- 產生了新的初始遷移，完整反映新的模型結構
- 成功建立了所有必要的資料表和關聯

### 4. 後果 (Consequences)

**正面影響**:

- **高度靈活性與擴展性**：此架構為未來增加新清單類型（如習慣追蹤、看板）打下了堅實的基礎，無需大規模重構。
- **職責分離**：不同清單類型的商業邏輯將被清晰地分離，易於開發、測試和維護。
- **滿足所有已知需求**：完整地支援了我們討論過的待辦事項、團隊投票、旅遊規劃等所有應用場景。
- **模組化設計**：每個模型都有自己的檔案，提高了程式碼的可維護性。

**負面影響 (已承擔的成本)**:

- **重構工作**：已完成 `backend/app/models/` 的重新設計和實施。
- **資料庫遷移重建**：已刪除現有的 Alembic 遷移版本，並根據新模型重新產生初始遷移腳本。
- **較高的初始複雜度**：相較於簡單模型，此架構的初始開發工作量較大，但已成功實施。

### 5. 遷移記錄 (Migration Notes)

**重要決策**：在開發階段選擇重置遷移歷史而非漸進式遷移。

**理由**：
- 專案仍在初期開發階段，沒有生產資料需要保護
- 新架構與舊架構差異過大，漸進式遷移會產生大量複雜的遷移檔案
- 重置後的初始遷移更清晰地反映了最終的資料結構

**未來考慮**：
- 生產環境部署後，所有架構變更都應使用漸進式遷移
- 建立資料備份和恢復程序
- 考慮建立專用的資料遷移工具

### 6. API 實施完成 (API Implementation Completed)

**實施日期**: 2025-07-01

**完成的 API 系統**：
- **ListItem API** (`/api/v1/list-items/`) - 完整的 CRUD 操作，支援投票數查詢
- **Vote API** (`/api/v1/votes/`) - 投票系統，防重複投票，支援民主決策
- **Event API** (`/api/v1/events/`) - 事件管理，支援日期範圍和即將到來的事件查詢

**核心功能實現**：
- ✅ 多清單類型支援 (TODO, PRIORITY)
- ✅ 協作投票機制
- ✅ 使用者權限控制
- ✅ 完整的資料驗證和錯誤處理
- ✅ RESTful API 設計原則

**實施文檔**：
- [ListItem API 實施詳情](../implementation/list-item-api.md)
- [Vote API 實施詳情](../implementation/vote-api.md)
- [Event API 實施詳情](../implementation/event-api.md)

此架構決策的完整實施為 DateTree 的核心協作功能奠定了堅實基礎。
